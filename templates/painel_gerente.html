{% extends 'base.html' %}
{% block content %}
<div class="p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Painel dos Gestores</h1>
    <div class="flex space-x-2">
      <button onclick="toggleFullScreen()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        ↖ Maximizar Tela
      </button>
      <a href="{{ url_for('logout') }}" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
        Logoff
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <form method="get" class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="block font-semibold mb-1">Analista</label>
      <select name="analista_id" class="border rounded w-full p-2">
        <optgroup label="Presencial">
          {% for a in analistas_presencial %}
            <option value="{{ a.id }}" {% if usuario_selecionado and a.id==usuario_selecionado.id %}selected{% endif %}>
              {{ a.nome }}
            </option>
          {% endfor %}
        </optgroup>
        <optgroup label="Teletrabalho">
          {% for a in analistas_teletrabalho %}
            <option value="{{ a.id }}" {% if usuario_selecionado and a.id==usuario_selecionado.id %}selected{% endif %}>
              {{ a.nome }}
            </option>
          {% endfor %}
        </optgroup>
      </select>
    </div>
    <div>
      <label class="block font-semibold mb-1">Mês</label>
      <select name="mes" class="border rounded w-full p-2">
        {% for m in meses %}
          <option value="{{ m }}" {% if m==mes %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block font-semibold mb-1">Semana</label>
      <select name="semana" class="border rounded w-full p-2">
        <option value="Mês inteiro" {% if selected_semana=='Mês inteiro' %}selected{% endif %}>Mês inteiro</option>
        {% for s in semanas %}
          <option value="{{ s }}" {% if s==selected_semana %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex items-end space-x-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Visualizar Produção
      </button>
      <button type="button" onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Imprimir
      </button>
    </div>
  </form>

  {% if usuario_selecionado %}
    <!-- Mini-relatório (igual ao Acompanhamento Pessoal) -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Produção de {{ usuario_selecionado.nome }} – {{ mes }}</h2>

      <!-- Progresso Mensal -->
      <div class="mb-4">
        <h3 class="font-semibold">Progresso Mensal</h3>
        <div class="w-full h-4 bg-gray-200 rounded mb-2">
          <div class="h-4 bg-green-500 rounded" style="width: {{ percentual_meta }}%"></div>
        </div>
        <p class="text-sm">{{ total_feito }} de {{ meta }} processos ({{ percentual_meta }}%)</p>
      </div>

      <!-- Gráfico -->
      <div class="mb-4">
        <h3 class="font-semibold">Gráfico de Produção</h3>
        <canvas id="graficoMini"></canvas>
      </div>

      <!-- Contagem -->
      <div>
        <h3 class="font-semibold mb-2">Contagem de Produção</h3>
        {% if selected_semana=='Mês inteiro' %}
          <table class="min-w-full border text-sm">
            <thead class="bg-blue-600 text-white">
              <tr>
                {% for c in campos %}
                  <th class="border px-2 py-1">{{ c.replace('_',' ')|title }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for c in campos %}
                  <td class="border px-2 py-1 text-center">{{ total_mes[c] }}</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        {% else %}
          <table class="min-w-full border text-sm">
            <thead class="bg-blue-600 text-white">
              <tr>
                {% for c in campos %}
                  <th class="border px-2 py-1">{{ c.replace('_',' ')|title }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for c in campos %}
                  <td class="border px-2 py-1 text-center">{{ totais[selected_semana][c] }}</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        {% endif %}
      </div>
    </div>

    <!-- Formulário de edição detalhada (sem alterações) -->
    <form method="post" action="{{ url_for('painel_gerente', analista_id=usuario_selecionado.id, mes=mes) }}">
      {% for s in semanas %}
        <div class="mb-6">
          <h3 class="font-semibold bg-blue-200 text-blue-900 px-3 py-2 rounded mb-2">Semana: {{ s }}</h3>
          <table class="w-full table-auto border">
            <thead class="bg-blue-400 text-white">
              <tr>
                <th class="border px-2">Linha</th>
                <th class="border px-2">Nº Processo</th>
                <th class="border px-2">Requerente</th>
                <th class="border px-2">Fase</th>
                {% for campo in totais[s].keys() %}
                  <th class="border px-2">{{ campo.replace('_',' ')|title }}</th>
                {% endfor %}
                <th class="border px-2">Observação</th>
              </tr>
            </thead>
            <tbody>
              {% for i in range(linhas) %}
                {% set p = processos_info[s][i] %}
                <tr>
                  <td class="border px-2">{{ i+1 }}</td>
                  <td class="border px-2">
                    <input type="text" name="{{ s }}_{{ i }}_numero_processo"
                           value="{{ p.numero_processo if p else '' }}" class="w-full border p-1">
                  </td>
                  <td class="border px-2">
                    <input type="text" name="{{ s }}_{{ i }}_requerente"
                           value="{{ p.requerente if p else '' }}" class="w-full border p-1">
                  </td>
                  <td class="border px-2">
                    <input type="text" name="{{ s }}_{{ i }}_fase"
                           value="{{ p.fase if p else '' }}" class="w-full border p-1">
                  </td>
                  {% for campo in totais[s].keys() %}
                    <td class="border px-2 text-center">
                      <input type="checkbox" name="{{ s }}_{{ i }}_{{ campo }}"
                             {% if p and (p|get_attr(campo)) %}checked{% endif %}>
                    </td>
                  {% endfor %}
                  <td class="border px-2">
                    <input type="text" name="{{ s }}_{{ i }}_obs"
                           value="{{ p.observacao if p else '' }}" class="w-full border p-1">
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
      <div class="text-right">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Salvar Produção
        </button>
      </div>
    </form>
  {% endif %}
</div>

<!-- Helpers and Mini Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function toggleFullScreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }

  const ctxMini = document.getElementById('graficoMini').getContext('2d');
  new Chart(ctxMini, {
    type: 'bar',
    data: {
      labels: {{ campos|tojson }},
      datasets: [{
        label: selected_semana === 'Mês inteiro' ? 'Mês inteiro' : selected_semana,
        data: selected_semana === 'Mês inteiro'
              ? {{ total_mes|tojson }}
              : {{ totais|tojson }}[selected_semana],
        backgroundColor: 'rgba(54,162,235,0.6)',
        borderColor: 'rgba(54,162,235,1)',
        borderWidth: 1
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endblock %}
