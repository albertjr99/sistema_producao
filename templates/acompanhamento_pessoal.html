@app.route('/acompanhamento-pessoal')
def acompanhamento_pessoal():
    if 'usuario_id' not in session or session['usuario_tipo'] != 'analista':
        flash('Acesso nÃ£o autorizado.')
        return redirect(url_for('index'))

    usuario = Usuario.query.get(session['usuario_id'])

    mes = datetime.now().strftime('%B').capitalize()
    meses = ['Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']
    ano = 2025
    mes_index = meses.index(mes) if mes in meses else 0
    semanas = gerar_semanas(mes_index + 6, ano)

    campos = ['averbacao', 'desaverbacao', 'conf_av_desav', 'ctc', 'conf_ctc', 'dtc',
              'conf_dtc', 'in_68', 'dpor', 'registro_atos', 'ag_completar', 'outros']

    totais = {}
    total_feito = 0
    for semana in semanas:
        contagem = {campo: 0 for campo in campos}
        processos = LinhaProducao.query.filter_by(usuario_id=usuario.id, semana=semana, mes=mes).all()
        for processo in processos:
            for campo in campos:
                if getattr(processo, campo):
                    contagem[campo] += 1
                    total_feito += 1
        totais[semana] = contagem

    meta = 112 if usuario.modalidade == 'teletrabalho' else 100
    percentual_meta = round((total_feito / meta) * 100, 1) if meta > 0 else 0

    return render_template(
        'acompanhamento_pessoal.html',
        usuario=usuario,
        semanas=semanas,
        totais=totais,
        campos=campos,
        total_feito=total_feito,
        meta=meta,
        percentual_meta=percentual_meta,
        mes=mes
    )

